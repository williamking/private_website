// Generated by LiveScript 1.3.1
(function(){
  var express, bcrypt, requireLogin, hasLogin, router;
  express = require('express');
  bcrypt = require('bcrypt');
  requireLogin = require('./authorization/authorize.js').requireLogin;
  hasLogin = require('./authorization/authorize').hasLogin;
  router = express.Router();
  router.get('/', function(req, res){
    console.log('hehe');
    res.render('index');
  });
  router.post('/login', hasLogin, function(req, res){
    var username, password;
    username = req.body.username;
    password = req.body.password;
    User.findOne({
      'name': username
    }, function(err, user){
      if (err) {
        res.send('error');
      } else {
        if (!user) {
          res.send('username not existed!');
        } else {
          if (!bcrypt(password, user.password)) {
            res.send('Error password!');
          } else {
            res.session.user = user._id;
            res.go('/');
          }
        }
      }
    });
  });
  router.get('/logout', requireLogin, function(req, res){
    res.session.user = null;
    res.go('/');
  });
  router.post('/reg', hasLogin, function(req, res){
    return User.register(req.body.username, req.body.password, req.body.email, req.body.signature, req.body.qq, req.body.birthday, function(err, user){
      if (err) {
        res.send('Reg error!');
      } else {
        res.session.user = user._id;
        res.go('/');
      }
    });
  });
  module.exports.index = router;
}).call(this);
