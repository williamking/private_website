# 一、引言
最近在给自己的做的个人小网盘应用里添加分享功能，想着干脆做一个视频在线观看功能试试。于是查了一下有关分片下载实现的机制，为什么像是迅雷这些软件能够进行断点续传下载，为何想在线视频网站的播放器可以跳进度在线加载观看，其中必定需要服务器的支持。果不其然，这些分片下载机制一般是利用HTTP协议中的206状态码以及头部的一些字段。下面就来说明以下206状态的分片下载的机制以及实现。

# 二、分片下载相关的头部状态信息
既然要实现分片，单凭一个206状态码当然是不够的，下面介绍与分片下载有关的几个Headers中的字段：
* Accept-Ranges: 服务器的响应报文中的头部字段，声明了服务器可被接受的资源范围请求，一般值为 bytes。
* Range: 这是客户端请求报文中的头部段，告知服务端请求资源的范围，值为 bytes=开始字节-结束字节。注意的是开始位置和结束位置是可以省略的，省略结束位置服务端会默认客户端请求的资源范围到资源的最后一个可用字节位置，省略开始位置保留结束位置，服务端会认为客户端请求的是从资源的末尾字节开始请求的字节数。
* Content-Range: 服务器响应报文中的头部字段，告知客户端当前返回数据资源的范围，值为 bytes 开始字节-结束字节/总字节大小 或 bytes \*/总字节大小(此种情况在后面会说明）。

# 三、分片下载相关状态码
* 206: Partial Content，告知客户端请求的资源是部分的片段。
* 416: Requested Range Not Satisfied，当客户端的请求头部的范围信息(Range)不合理时，返回的状态码。

# 四、分片下载的交互
下面举例说明分片下载的交互流程（只列出分片下载相关信息头部）：
1.客户端发送某视频资源的请求报文
```
GET /fate-stay-night.mp4 HTTP/1.1
Range: bytes=0-511
```
这里请求的是视频的0-511字节范围的数据，若是要请求最后512个字节，则报文为:
```
GET /fate-stay-night.mp4 HTTP/1.1
Range: bytes=-512
```
2.服务端返回报文
下面报文对应第1步第一种情况的请求。
```
HTTP/1.1 206 Partial Content
Content-Type: video/mp4
Content-Range: bytes 0-511/1024
Content-Length: 512
```
下面报文对应第1步第二种情况的请求。
```
HTTP/1.1 206 Partial Content
Content-Type: video/mp4
Content-Range: bytes 512-1023/1024
Content-Length: 512
```
若是请求的范围不合理，比如超出了资源的请求范围，则返回416状态，同时在头部告知资源的范围。
```
HTTP/1.1 416 Requested Range Not Satisfiable
Content-Range: bytes */1024
```

# 五、分片下载机制的实现
知道了分片下载的机制，服务端实现起来就简单了。主要思路还是通过读取头部响应的信息字段，获取客户端需要的资源的字节范围，然后提取出对应的数据，生成对应的响应信息头部返回到客户端。具体实现的代码就不贴出来了，在下面的参考链接里有实现的参考代码。

本文内容参考该链接: [Node.js 中实现 HTTP 206 内容分片](https://www.oschina.net/translate/http-partial-content-in-node-js)