// Generated by LiveScript 1.3.1
(function(){
  var express, bcrypt, requireLogin, hasLogin, User, router;
  express = require('express');
  bcrypt = require('bcrypt');
  requireLogin = require('./authorization/authorize.js').requireLogin;
  hasLogin = require('./authorization/authorize').hasLogin;
  User = require('../models/User.js');
  router = express.Router();
  router.get('/', function(req, res){
    res.render('index', {
      user: req.session.user,
      username: req.session.username
    });
  });
  router.post('/login', hasLogin, function(req, res){
    var username, password, salt, hash;
    username = req.body.username;
    password = req.body.password;
    console.log(password);
    salt = bcrypt.genSaltSync(10);
    hash = bcrypt.hashSync(password, salt);
    console.log(salt);
    User.findOne({
      'name': username
    }, function(err, user){
      if (err) {
        res.status(500).send('Server error');
        res.end();
        return;
      } else {
        if (!user) {
          res.json({
            result: 'Error',
            msg: 'Username not existed!'
          });
          return;
        } else {
          console.log(user.password);
          if (!bcrypt.compareSync(password, user.password)) {
            res.json({
              result: 'Error',
              msg: 'Wrong password!'
            });
            return;
          } else {
            req.session.user = user._id;
            req.session.username = user.name;
            req.session.type = user.type;
            res.json({
              result: 'Success',
              msg: ''
            });
            return;
          }
        }
      }
    });
  });
  router.get('/logout', requireLogin, function(req, res){
    req.session.user = null;
    req.session.type = null;
    res.json({
      result: 'Success',
      msg: ""
    });
  });
  router.post('/reg', hasLogin, function(req, res){
    return User.register(req.body.username, req.body.password, req.body.type, req.body.email, req.body.signature, req.body.qq, req.body.birthday, function(err, user){
      if (err) {
        res.status(500).send(err.message);
        console.log(err);
        res.end();
      } else {
        req.session.user = user._id;
        req.session.username = user.name;
        req.session.type = user.type;
        res.json({
          result: 'success'
        });
      }
    });
  });
  module.exports = router;
}).call(this);
