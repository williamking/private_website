// Generated by LiveScript 1.3.1
(function(){
  var express, bcrypt, requireLogin, hasLogin, User, router;
  express = require('express');
  bcrypt = require('bcrypt');
  requireLogin = require('./authorization/authorize.js').requireLogin;
  hasLogin = require('./authorization/authorize').hasLogin;
  User = require('../models/User.js');
  router = express.Router();
  router.get('/', function(req, res){
    res.render('index', {
      user: req.session.user
    });
  });
  router.post('/login', hasLogin, function(req, res){
    var username, password;
    username = req.body.username;
    password = req.body.password;
    User.findOne({
      'name': username
    }, function(err, user){
      console.log(err);
      if (err) {
        res.status(500).send('Server error');
        res.end();
        return;
      } else {
        if (!user) {
          res.json({
            result: 'Error',
            msg: 'Username not existed!'
          });
          return;
        } else {
          if (!bcrypt(password, user.password)) {
            res.json({
              result: 'Error',
              'Error password!': 'Error password!'
            });
            return;
          } else {
            res.session.user = user._id;
            res.session.type = user.type;
            res.json({
              result: 'Success'
            });
            return;
          }
        }
      }
    });
  });
  router.get('/logout', requireLogin, function(req, res){
    res.session.user = null;
    res.seesion.type = null;
    res.json({
      result: 'sucess'
    });
    res.end();
  });
  router.post('/reg', hasLogin, function(req, res){
    return User.register(req.body.username, req.body.password, req.body.email, req.body.signature, req.body.qq, req.body.birthday, function(err, user){
      if (err) {
        res.send('Reg error!');
      } else {
        res.session.user = user._id;
        res.go('/');
      }
    });
  });
  module.exports = router;
}).call(this);
